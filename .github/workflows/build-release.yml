name: Build and Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      create_release:
        description: 'Create a release with current build'
        required: true
        default: false
        type: boolean

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Get version
      id: get_version
      shell: pwsh
      run: |
        if ($env:GITHUB_REF -like 'refs/tags/*') {
          $version = $env:GITHUB_REF.Substring(10)
          $tag = $version
        } else {
          $date = (Get-Date).ToUniversalTime().AddHours(8).ToString('yyyy.MMdd.HHmm')
          $tag = "v$date"
          $version = $tag
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"
          git tag $tag
          git push origin $tag
        }
        echo "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        echo "tag=$tag" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        echo "__version__ = '$version'" | Out-File -FilePath src/one_dragon/version.py -Encoding utf8

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11.9'

    - name: Install uv
      shell: pwsh
      run: |
        Invoke-WebRequest -Uri https://astral.sh/uv/install.ps1 -OutFile install.ps1
        .\install.ps1

    - name: Create and activate virtual environment
      shell: pwsh
      run: |
        uv venv .venv --python=3.11.12

    - name: Install dependencies
      shell: pwsh
      run: |
        .\.venv\Scripts\Activate.ps1
        uv sync --all-groups

    - name: Download and extract UPX into venv Scripts
      shell: pwsh
      run: |
        $venvScripts = ".\.venv\Scripts"
        $upxDir = Join-Path $venvScripts "upx"
        $sourceUpxPath = Join-Path $upxDir "upx-4.2.3-win64" "upx.exe"
        $destinationUpxPath = Join-Path $venvScripts "upx.exe"
        $zipPath = "upx.zip"

        Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.2.3/upx-4.2.3-win64.zip" -OutFile $zipPath
        Expand-Archive -Path $zipPath -DestinationPath $upxDir -Force
        Move-Item -Path $sourceUpxPath -Destination $destinationUpxPath -Force
        Remove-Item -Path $upxDir -Recurse -Force

    - name: Build executables
      shell: pwsh
      run: |
        .\.venv\Scripts\Activate.ps1
        cd deploy
        pyinstaller "OneDragon-Installer.spec"
        pyinstaller "OneDragon-Launcher.spec"

    - name: Bundle dependencies into wheels
      shell: pwsh
      run: |
        # æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
        .\.venv\Scripts\Activate.ps1

        # åˆ›å»ºç›®æ ‡ç›®å½•å¹¶ç”Ÿæˆ wheel åŒ…
        New-Item -ItemType Directory -Path deploy/dist/wheels -Force
        uv export --no-hashes --no-dev --format requirements-txt > requirements-prod.txt
        pip wheel --wheel-dir=deploy/dist/wheels -r requirements-prod.txt

        # å‹ç¼©ç”Ÿæˆçš„ wheels ç›®å½•
        Compress-Archive -Path deploy/dist/wheels/* -DestinationPath deploy/dist/ZenlessZoneZero-OneDragon-Environment.zip

    - name: Upload Installer
      uses: actions/upload-artifact@v4
      with:
        name: Installer
        path: deploy/dist/OneDragon-Installer.exe

    - name: Upload Launcher
      uses: actions/upload-artifact@v4
      with:
        name: Launcher
        path: deploy/dist/OneDragon-Launcher.exe

    - name: Upload Wheels
      uses: actions/upload-artifact@v4
      with:
        name: Wheels
        path: deploy/dist/ZenlessZoneZero-OneDragon-Environment.zip

    - name: Prepare release directory and models
      if: ${{ (github.event_name == 'workflow_dispatch' && inputs.create_release == true) || startsWith(github.ref, 'refs/tags/') }}
      shell: pwsh
      run: |
        function Expand-ZipIntoNamedFolder {
            param (
                [string]$url,
                [string]$downloadPath,
                [string]$destRoot,
                [string]$folderName
            )
            Invoke-WebRequest -Uri $url -OutFile $downloadPath
            $targetPath = Join-Path $destRoot $folderName
            New-Item -ItemType Directory -Path $targetPath -Force
            Expand-Archive -Path $downloadPath -DestinationPath $targetPath -Force
        }

        $distDir = "deploy/dist"
        $rootDir = "$distDir/ZenlessZoneZero-OneDragon"
        New-Item -ItemType Directory -Path $rootDir -Force

        # .install
        $envDir = "$rootDir/.install"
        New-Item -ItemType Directory -Path $envDir -Force
        Invoke-WebRequest -Uri "https://github.com/OneDragon-Anything/OneDragon-Env/releases/download/ZenlessZoneZero-OneDragon/uv-x86_64-pc-windows-msvc.zip" -OutFile "$envDir/uv-x86_64-pc-windows-msvc.zip"
        Invoke-WebRequest -Uri "https://github.com/OneDragon-Anything/OneDragon-Env/releases/download/ZenlessZoneZero-OneDragon/MinGit.zip" -OutFile "$envDir/MinGit.zip"

        # ä¸‹è½½å¹¶æå–Python
        $pythonDir = "$envDir/python"
        $pythonTargetDir = "$pythonDir/cpython-3.11.12-windows-x86_64-none"
        New-Item -ItemType Directory -Path $pythonTargetDir -Force
        $pythonTarGz = "$envDir/python.tar.gz"
        Invoke-WebRequest -Uri "https://github.com/astral-sh/python-build-standalone/releases/download/20250517/cpython-3.11.12+20250517-x86_64-pc-windows-msvc-install_only_stripped.tar.gz" -OutFile $pythonTarGz

        # æå– tar.gz æ–‡ä»¶
        tar -xzf $pythonTarGz -C $pythonTargetDir --strip-components=1
        Remove-Item -Path $pythonTarGz -Force

        # å¤åˆ¶å®‰è£…å™¨
        Copy-Item "$distDir/OneDragon-Installer.exe" -Destination $rootDir -Force

        # æ‰“åŒ…å¯åŠ¨å™¨
        Compress-Archive -Path "$distDir/OneDragon-Launcher.exe" -DestinationPath "$distDir/ZenlessZoneZero-OneDragon-Launcher.zip" -Force
        Copy-Item "$distDir/ZenlessZoneZero-OneDragon-Launcher.zip" -Destination $envDir -Force

        # å¤åˆ¶èµ„æºæ–‡ä»¶
        Copy-Item "assets/text" -Destination "$rootDir/assets/text" -Recurse -Force
        Copy-Item "assets/ui" -Destination "$rootDir/assets/ui" -Recurse -Force

        # åˆ›å»ºæ¨¡å‹ç›®å½•
        $modelBase = "$rootDir/assets/models"
        New-Item -ItemType Directory -Path "$modelBase/onnx_ocr" -Force
        New-Item -ItemType Directory -Path "$modelBase/flash_classifier" -Force
        New-Item -ItemType Directory -Path "$modelBase/hollow_zero_event" -Force
        New-Item -ItemType Directory -Path "$modelBase/lost_void_det" -Force

        # ä¸´æ—¶æ¨¡å‹ç›®å½•
        $tempDir = "temp_models"
        New-Item -ItemType Directory -Path $tempDir -Force

        # é€šè¿‡æ–‡ä»¶æœ«å°¾æœ€é«˜8ä½æ•°å­—è·å–æœ€æ–°æ¨¡å‹
        function Get-LatestModelByNumber {
            param (
                [string]$repo,
                [string]$pattern
            )
            $apiUrl = "https://api.github.com/repos/$repo/releases"
            $releases = Invoke-RestMethod -Uri $apiUrl -Headers @{ "Accept" = "application/vnd.github.v3+json" }

            $bestAsset = $null
            $maxNumber = -1

            foreach ($release in $releases) {
                foreach ($asset in $release.assets) {
                    if ($asset.name -match $pattern) {
                        # ä»æ–‡ä»¶åæœ«å°¾æå–8ä½æ•°å­—ï¼ˆåœ¨.zipä¹‹å‰ï¼‰
                        if ($asset.name -match '(\d{8})\.zip$') {
                            $number = [int]$matches[1]
                            if ($number -gt $maxNumber) {
                                $maxNumber = $number
                                $bestAsset = @{
                                    url = $asset.browser_download_url
                                    name = $asset.name
                                    version_number = $number
                                }
                            }
                        }
                        # å¯¹äºppocrv5å’Œå…¶ä»–æ²¡æœ‰8ä½æ•°å­—åç¼€çš„æ¨¡å‹ï¼Œä½œä¸ºå¤‡ç”¨é€‰é¡¹
                        elseif ($bestAsset -eq $null) {
                            $bestAsset = @{
                                url = $asset.browser_download_url
                                name = $asset.name
                                version_number = 0
                            }
                        }
                    }
                }
            }
            return $bestAsset
        }

        # é€šè¿‡æœ€é«˜ç‰ˆæœ¬å·è·å–æœ€æ–°æ¨¡å‹
        Write-Host "æ­£åœ¨è·å–æœ€æ–°æ¨¡å‹ä¿¡æ¯..."

        # è·å– ppocrv5 æ¨¡å‹ (onnx_ocr)
        $ppocrModel = Get-LatestModelByNumber -repo "OneDragon-Anything/OneDragon-Env" -pattern "ppocrv5\.zip$"
        if ($ppocrModel) {
            $ppocrName = $ppocrModel.name -replace "\.zip$", ""
            Write-Host "æ‰¾åˆ° ppocrv5 æ¨¡å‹: $($ppocrModel.name) (ç‰ˆæœ¬: $($ppocrModel.version_number))"
            Expand-ZipIntoNamedFolder `
              -url $ppocrModel.url `
              -downloadPath "$tempDir/ppocrv5.zip" `
              -destRoot "$modelBase/onnx_ocr" `
              -folderName $ppocrName
        } else {
            Write-Warning "æ— æ³•æ‰¾åˆ° ppocrv5 æ¨¡å‹ï¼Œä½¿ç”¨å¤‡ç”¨ç‰ˆæœ¬"
            Expand-ZipIntoNamedFolder `
              -url "https://github.com/OneDragon-Anything/OneDragon-Env/releases/download/ppocrv5/ppocrv5.zip" `
              -downloadPath "$tempDir/ppocrv5.zip" `
              -destRoot "$modelBase/onnx_ocr" `
              -folderName "ppocrv5"
        }

        # è·å– flash classifier æ¨¡å‹
        $flashModel = Get-LatestModelByNumber -repo "OneDragon-Anything/OneDragon-YOLO" -pattern "flash.*\.zip$"
        if ($flashModel) {
            $flashName = $flashModel.name -replace "\.zip$", ""
            Write-Host "æ‰¾åˆ° flash æ¨¡å‹: $($flashModel.name) (ç‰ˆæœ¬: $($flashModel.version_number))"
            Expand-ZipIntoNamedFolder `
              -url $flashModel.url `
              -downloadPath "$tempDir/flash.zip" `
              -destRoot "$modelBase/flash_classifier" `
              -folderName $flashName
        } else {
            Write-Warning "æ— æ³•æ‰¾åˆ° flash æ¨¡å‹ï¼Œä½¿ç”¨å¤‡ç”¨ç‰ˆæœ¬"
            Expand-ZipIntoNamedFolder `
              -url "https://github.com/OneDragon-Anything/OneDragon-YOLO/releases/download/zzz_model/yolov8n-640-flash-0127.zip" `
              -downloadPath "$tempDir/flash.zip" `
              -destRoot "$modelBase/flash_classifier" `
              -folderName "yolov8n-640-flash-0127"
        }

        # è·å– hollow zero event æ¨¡å‹
        $hollowModel = Get-LatestModelByNumber -repo "OneDragon-Anything/OneDragon-YOLO" -pattern "hollow.*\.zip$"
        if ($hollowModel) {
            $hollowName = $hollowModel.name -replace "\.zip$", ""
            Write-Host "æ‰¾åˆ° hollow æ¨¡å‹: $($hollowModel.name) (ç‰ˆæœ¬: $($hollowModel.version_number))"
            Expand-ZipIntoNamedFolder `
              -url $hollowModel.url `
              -downloadPath "$tempDir/hollow.zip" `
              -destRoot "$modelBase/hollow_zero_event" `
              -folderName $hollowName
        } else {
            Write-Warning "æ— æ³•æ‰¾åˆ° hollow æ¨¡å‹ï¼Œä½¿ç”¨å¤‡ç”¨ç‰ˆæœ¬"
            Expand-ZipIntoNamedFolder `
              -url "https://github.com/OneDragon-Anything/OneDragon-YOLO/releases/download/zzz_model/yolov8s-736-hollow-zero-event-0126.zip" `
              -downloadPath "$tempDir/hollow.zip" `
              -destRoot "$modelBase/hollow_zero_event" `
              -folderName "yolov8s-736-hollow-zero-event-0126"
        }

        # è·å– lost void detection æ¨¡å‹
        $lostModel = Get-LatestModelByNumber -repo "OneDragon-Anything/OneDragon-YOLO" -pattern "lost.*\.zip$"
        if ($lostModel) {
            $lostName = $lostModel.name -replace "\.zip$", ""
            Write-Host "æ‰¾åˆ° lost void æ¨¡å‹: $($lostModel.name) (ç‰ˆæœ¬: $($lostModel.version_number))"
            Expand-ZipIntoNamedFolder `
              -url $lostModel.url `
              -downloadPath "$tempDir/lost.zip" `
              -destRoot "$modelBase/lost_void_det" `
              -folderName $lostName
        } else {
            Write-Warning "æ— æ³•æ‰¾åˆ° lost void æ¨¡å‹ï¼Œä½¿ç”¨å¤‡ç”¨ç‰ˆæœ¬"
            Expand-ZipIntoNamedFolder `
              -url "https://github.com/OneDragon-Anything/OneDragon-YOLO/releases/download/zzz_model/yolov8n-736-lost-void-det-20250612.zip" `
              -downloadPath "$tempDir/lost.zip" `
              -destRoot "$modelBase/lost_void_det" `
              -folderName "yolov8n-736-lost-void-det-20250612"
        }

        # è·å–ç‰ˆæœ¬å·
        $version = "${{ steps.get_version.outputs.version }}"

        # æ‰“åŒ…å®Œæ•´ç‰ˆæœ¬
        Compress-Archive -Path "$rootDir/*" -DestinationPath "$distDir/ZenlessZoneZero-OneDragon-$version-Full.zip" -Force

        # å¤åˆ¶ç¯å¢ƒä¾èµ–åˆ° .install ç›®å½•
        Copy-Item "$distDir/ZenlessZoneZero-OneDragon-Environment.zip" -Destination "$rootDir/.install/ZenlessZoneZero-OneDragon-Environment.zip" -Force

        # æ‰“åŒ…å¸¦ç¯å¢ƒçš„å®Œæ•´ç‰ˆæœ¬
        Compress-Archive -Path "$rootDir/*" -DestinationPath "$distDir/ZenlessZoneZero-OneDragon-$version-Full-Environment.zip" -Force

        # å¤åˆ¶å®‰è£…ç¨‹åº
        Copy-Item "$rootDir/OneDragon-Installer.exe" -Destination "$distDir/ZenlessZoneZero-OneDragon-$version-Installer.exe" -Force

    - name: Generate Changelog
      id: changelog
      if: ${{ (github.event_name == 'workflow_dispatch' && inputs.create_release == true) || startsWith(github.ref, 'refs/tags/') }}
      shell: pwsh
      run: |
        $current_version_tag = "${{ steps.get_version.outputs.tag }}" # ä» get_version æ­¥éª¤è·å–çš„æ ‡ç­¾
        $commits = @()

        if ($env:GITHUB_REF -like 'refs/tags/*') {
          # è¿™æ˜¯ç”±æ ‡ç­¾è§¦å‘çš„å‘å¸ƒ
          # å°è¯•æŸ¥æ‰¾å½“å‰æ ‡ç­¾æäº¤çš„çˆ¶æäº¤ä¸Šçš„æœ€æ–°æ ‡ç­¾
          $previous_tag_candidate = $(git describe --tags --abbrev=0 "$current_version_tag^" 2>$null)
          if ($previous_tag_candidate) {
            Write-Host "æ­£åœ¨ç”Ÿæˆä» $previous_tag_candidate åˆ° $current_version_tag çš„æ›´æ–°æ—¥å¿—"
            $commits = git log --pretty=format:"%s|%h" "$previous_tag_candidate..$current_version_tag"
          } else {
            Write-Host "æœªæ‰¾åˆ°ç›¸å¯¹äº $current_version_tag^ çš„ä¸Šä¸€ä¸ªæ ‡ç­¾ã€‚åˆ—å‡º $current_version_tag çš„æœ€å10ä¸ªæäº¤ã€‚"
            # è¿™å¯èƒ½æ˜¯ç¬¬ä¸€ä¸ªæ ‡ç­¾ã€‚åˆ—å‡ºå¯¼è‡´å®ƒçš„æäº¤ã€‚
            $commits = git log --pretty=format:"%s|%h" -n 10 "$current_version_tag"
          }
        } else {
          # è¿™æ˜¯æ‰‹åŠ¨ workflow_dispatch æˆ–åˆ†æ”¯æ¨é€
          Write-Host "æ‰‹åŠ¨æˆ–åˆ†æ”¯æ„å»ºã€‚åˆ—å‡º HEAD çš„æœ€å5ä¸ªæäº¤ã€‚"
          $commits = git log --pretty=format:"%s|%h" -n 5 HEAD
        }

        # æŒ‰å‰ç¼€åˆ†ç±»æäº¤
        $categories = @{
          "feat" = @()
          "fix" = @()
          "perf" = @()
          "refactor" = @()
          "style" = @()
          "docs" = @()
          "test" = @()
          "ci" = @()
          "build" = @()
          "chore" = @()
          "revert" = @()
          "other" = @()
        }

        foreach ($commit in $commits) {
          if ($commit -match "^(.+)\|(.+)$") {
            $message = $matches[1]
            $hash = $matches[2]

            # æå–å†’å·å‰çš„å‰ç¼€
            if ($message -match "^([^:]+):(.*)$") {
              $prefix = $matches[1].Trim().ToLower()
              $content = $matches[2].Trim()

              # æ£€æŸ¥å‰ç¼€æ˜¯å¦åœ¨å·²çŸ¥åˆ†ç±»ä¸­
              if ($categories.ContainsKey($prefix)) {
                $categories[$prefix] += "- $content ($hash)"
              } else {
                $categories["other"] += "- $message ($hash)"
              }
            } else {
              $categories["other"] += "- $message ($hash)"
            }
          }
        }

        # ç”Ÿæˆåˆ†ç±»åçš„æ›´æ–°æ—¥å¿—
        $changelog_content = ""
        $category_names = @{
          "feat" = "âœ¨ æ–°åŠŸèƒ½"
          "fix" = "ğŸ› Bug ä¿®å¤"
          "perf" = "âš¡ æ€§èƒ½ä¼˜åŒ–"
          "refactor" = "â™»ï¸ ä»£ç é‡æ„"
          "style" = "ğŸ’„ æ ·å¼è°ƒæ•´"
          "docs" = "ğŸ“„ æ–‡æ¡£æ›´æ–°"
          "test" = "âœ… æµ‹è¯•"
          "ci" = "ğŸ‘· CI/CD"
          "build" = "ğŸ“¦ æ„å»º"
          "chore" = "ğŸ”§ æ‚é¡¹"
          "revert" = "âª å›æ»š"
          "other" = "ğŸ“ å…¶ä»–æ›´æ”¹"
        }

        # å®šä¹‰è¾“å‡ºé¡ºåº
        $ordered_keys = @("feat", "fix", "perf", "refactor", "style", "docs", "test", "ci", "build", "chore", "revert", "other")

        foreach ($key in $ordered_keys) {
          if ($categories[$key].Count -gt 0) {
            if ($changelog_content -ne "") {
              $changelog_content += "`n`n"
            }
            $changelog_content += "## $($category_names[$key])`n"
            $changelog_content += ($categories[$key] -join "`n")
          }
        }

        if ([string]::IsNullOrWhiteSpace($changelog_content)) {
          $changelog_content = "æ²¡æœ‰æ–°çš„æ›´æ”¹æˆ–æ— æ³•ç¡®å®šæ›´æ–°æ—¥å¿—ã€‚"
        }

        $output_name = "clean_changelog"
        $delimiter = "CHANGELOG_DELIMITER_$(New-Guid)"

        echo "$output_name<<$delimiter" | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        echo $changelog_content | Out-File -FilePath $env:GITHUB_OUTPUT -Append
        echo $delimiter | Out-File -FilePath $env:GITHUB_OUTPUT -Append

    - name: Create Release
      if: ${{ (github.event_name == 'workflow_dispatch' && inputs.create_release == true) || startsWith(github.ref, 'refs/tags/') }}
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.tag }}
        name: "Release ${{ steps.get_version.outputs.version }}"
        body: |
          # å®‰è£…æ–¹å¼

          - `ZenlessZoneZero-OneDragon-${{ steps.get_version.outputs.version }}-Full-Environment.zip` ä¸ºå¸¦ç¯å¢ƒçš„å®Œæ•´åŒ…ï¼Œä¸éœ€è¦é¢å¤–ä¸‹è½½èµ„æºã€‚
          - `ZenlessZoneZero-OneDragon-${{ steps.get_version.outputs.version }}-Full.zip` ä¸ºå®Œæ•´åŒ…ï¼Œè§£å‹åé€‰æ‹©è§£å‹ç›®å½•ä¸ºå®‰è£…ç›®å½•ï¼Œåªéœ€è¦ä¸‹è½½ç¯å¢ƒä¾èµ–ã€‚
          - `ZenlessZoneZero-OneDragon-${{ steps.get_version.outputs.version }}-Installer.exe` ä¸ºç²¾ç®€å®‰è£…ç¨‹åºï¼Œè¿è¡Œåä¼šè‡ªåŠ¨ä¸‹è½½æ‰€éœ€çš„èµ„æºã€‚
          - å¦‚æœä½ æƒ³æ›´æ–°å¯åŠ¨å™¨ï¼Œå‰å¾€ä¸»ç¨‹åºã€è®¾ç½®ã€‘-ã€èµ„æºä¸‹è½½ã€‘é¡µé¢æ›´æ–°ï¼Œæˆ–è€…ä¸‹è½½ `ZenlessZoneZero-OneDragon-Launcher.zip`ï¼Œè§£å‹åæ›¿æ¢ã€‚
          - __ä¸è¦ä¸‹è½½Source Code__

          å®‰è£…å‰è¯·æŸ¥çœ‹ [å®‰è£…æŒ‡å—](https://one-dragon.com/zzz/zh/quickstart.html)
          è‹¥è¿è¡Œå‡ºé”™è¯·æŸ¥çœ‹ [è‡ªåŠ©æ’éšœæŒ‡å—](https://docs.qq.com/doc/p/7add96a4600d363b75d2df83bb2635a7c6a969b5)

          # æ›´æ–°å†…å®¹

          ${{ steps.changelog.outputs.clean_changelog }}
        files: |
          deploy/dist/ZenlessZoneZero-OneDragon-${{ steps.get_version.outputs.version }}-Full-Environment.zip
          deploy/dist/ZenlessZoneZero-OneDragon-${{ steps.get_version.outputs.version }}-Full.zip
          deploy/dist/ZenlessZoneZero-OneDragon-${{ steps.get_version.outputs.version }}-Installer.exe
          deploy/dist/ZenlessZoneZero-OneDragon-Environment.zip
          deploy/dist/ZenlessZoneZero-OneDragon-Launcher.zip
        generate_release_notes: false
        prerelease: ${{ github.event_name == 'workflow_dispatch' }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
